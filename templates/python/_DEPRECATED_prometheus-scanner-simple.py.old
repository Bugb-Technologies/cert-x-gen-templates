#!/usr/bin/env python3
"""
Prometheus Unauthenticated Access Scanner

Quick scanner for exposed Prometheus instances and exporters.
Works with CERT-X-GEN engine.

Author: CERT-X-GEN Security Team
Severity: High
CWE: CWE-200
"""

import json
import sys
import os
import urllib.request
import socket

# Default exporters to check
DEFAULT_EXPORTERS = [
    {"name": "Node Exporter", "port": 9100, "path": "/metrics", "signatures": ["node_exporter", "node_cpu"]},
    {"name": "Prometheus Server", "port": 9090, "path": "/metrics", "signatures": ["prometheus_build_info"]},
    {"name": "cAdvisor", "port": 8080, "path": "/metrics", "signatures": ["container_cpu", "cadvisor"]},
    {"name": "MySQL Exporter", "port": 9104, "path": "/metrics", "signatures": ["mysql_"]},
    {"name": "PostgreSQL Exporter", "port": 9187, "path": "/metrics", "signatures": ["pg_"]},
    {"name": "Redis Exporter", "port": 9121, "path": "/metrics", "signatures": ["redis_"]},
]

def get_ports_to_scan():
    """Get list of ports to scan based on environment configuration"""
    # Check for port override
    if "CERT_X_GEN_OVERRIDE_PORTS" in os.environ:
        override_ports = os.environ["CERT_X_GEN_OVERRIDE_PORTS"]
        ports = [int(p.strip()) for p in override_ports.split(',') if p.strip()]
        return ports, True  # True = override mode
    
    # Otherwise, get default ports and add any additional ones
    default_ports = [exp['port'] for exp in DEFAULT_EXPORTERS]
    
    if "CERT_X_GEN_ADD_PORTS" in os.environ:
        add_ports = os.environ["CERT_X_GEN_ADD_PORTS"]
        additional_ports = [int(p.strip()) for p in add_ports.split(',') if p.strip()]
        # Merge and deduplicate
        all_ports = list(set(default_ports + additional_ports))
        return sorted(all_ports), False  # False = additive mode
    
    return default_ports, False

# Build exporters list based on port configuration
def build_exporters_list():
    """Build the list of exporters to check based on port configuration"""
    ports_to_scan, is_override = get_ports_to_scan()
    
    if is_override:
        # Override mode: create generic exporters for specified ports
        return [
            {
                "name": f"Prometheus Endpoint (port {port})",
                "port": port,
                "path": "/metrics",
                "signatures": ["# HELP", "# TYPE"]  # Generic Prometheus signatures
            }
            for port in ports_to_scan
        ]
    else:
        # Additive mode: use defaults + create entries for additional ports
        exporters = list(DEFAULT_EXPORTERS)
        default_ports = {exp['port'] for exp in DEFAULT_EXPORTERS}
        
        for port in ports_to_scan:
            if port not in default_ports:
                exporters.append({
                    "name": f"Prometheus Endpoint (port {port})",
                    "port": port,
                    "path": "/metrics",
                    "signatures": ["# HELP", "# TYPE"]
                })
        
        return exporters

EXPORTERS = build_exporters_list()

def check_exporter(host, exporter):
    """Check if an exporter is accessible"""
    try:
        url = f"http://{host}:{exporter['port']}{exporter['path']}"
        req = urllib.request.Request(url, headers={'User-Agent': 'CERT-X-GEN/1.0'})
        
        with urllib.request.urlopen(req, timeout=3) as response:
            body = response.read().decode('utf-8', errors='ignore')
            
            # Check for signatures
            for sig in exporter['signatures']:
                if sig in body:
                    return {
                        "template_id": "prometheus-unauthenticated",
                        "severity": "high",
                        "confidence": 95,
                        "title": f"{exporter['name']} Exposed Without Authentication",
                        "description": f"{exporter['name']} at {host}:{exporter['port']} is accessible without authentication",
                        "evidence": {
                            "exporter": exporter['name'],
                            "endpoint": url,
                            "port": exporter['port'],
                            "status_code": 200,
                            "response_size": len(body)
                        },
                        "cwe": "CWE-200",
                        "cvss_score": 7.5,
                        "remediation": "Enable authentication using reverse proxy or configure exporter with TLS and basic auth",
                        "references": [
                            "https://prometheus.io/docs/guides/basic-auth/",
                            "https://cwe.mitre.org/data/definitions/200.html"
                        ]
                    }
    except:
        pass
    
    return None

def main():
    # Get target from arguments or environment
    target = None
    if len(sys.argv) > 1:
        target = sys.argv[1]
    elif "CERT_X_GEN_TARGET_HOST" in os.environ:
        target = os.environ["CERT_X_GEN_TARGET_HOST"]
    
    if not target:
        print("Error: No target specified", file=sys.stderr)
        sys.exit(1)
    
    # Check if running in engine mode
    engine_mode = os.environ.get("CERT_X_GEN_MODE") == "engine" or "--json" in sys.argv
    
    findings = []
    
    if not engine_mode:
        print(f"\n[*] Scanning {target} for exposed Prometheus exporters...\n")
    
    for exporter in EXPORTERS:
        if not engine_mode:
            print(f"[*] Testing {exporter['name']} on port {exporter['port']}...")
        
        finding = check_exporter(target, exporter)
        if finding:
            findings.append(finding)
            if not engine_mode:
                print(f"    [+] FOUND: {exporter['name']} is exposed!")
    
    # Output results
    if engine_mode:
        # JSON output for CERT-X-GEN
        print(json.dumps(findings, indent=2))
    else:
        # Human-readable output
        print(f"\n[+] Scan complete. Found {len(findings)} exposed exporter(s)\n")
        for finding in findings:
            print(f"[{finding['severity'].upper()}] {finding['title']}")
            print(f"    {finding['description']}")
            print(f"    Endpoint: {finding['evidence']['endpoint']}")
            print()

if __name__ == "__main__":
    main()
