id: cockroachdb-unauthenticated-access
name: "CockroachDB Unauthenticated Access Detection"
author:
  name: "CERT-X-GEN Security Team"
  email: "security@cert-x-gen.io"
severity: critical
description: |
  Detects CockroachDB instances exposed without authentication.
  Tests for:
  - Admin UI access without credentials
  - SQL endpoint accessibility
  - Cluster information disclosure
  - Database enumeration

tags:
  - cockroachdb
  - database
  - unauthenticated
  - sql
  - distributed
  - cluster

language: yaml
confidence: 95

cwe:
  - CWE-306

references:
  - https://cwe.mitre.org/data/definitions/306.html
  - https://www.cockroachlabs.com/docs/stable/security-reference/
  - https://owasp.org/www-community/vulnerabilities/Broken_Authentication

http:
  # Admin UI endpoints
  - method: GET
    path:
      - "/"
      - "/#/overview"
      - "/_admin/v1/health"
      - "/_admin/v1/nodes"
      - "/_admin/v1/databases"
      - "/_status/vars"
      - "/health"
    
    ports:
      - 8080  # Default Admin UI port
      - 8081
      - 26257 # Default SQL port (may have HTTP API)
    
    matchers-condition: or
    matchers:
      - type: word
        words:
          - "CockroachDB"
          - "cockroach"
          - "Cluster Overview"
          - "cluster_id"
          - "node_id"
        condition: or
        part: body
      
      - type: regex
        regex:
          - '"build_tag":"v\\d+\\.\\d+\\.\\d+"'
          - '"node_id":\\d+'
          - 'cockroachdb\\..*'
      
      - type: status
        status:
          - 200

  # Health check endpoint
  - method: GET
    path:
      - "/health?ready=1"
      - "/_status/health"
    
    matchers:
      - type: word
        words:
          - '"isAvailable":true'
          - "ok"

  # Nodes information
  - method: GET
    path:
      - "/_status/nodes"
      - "/_admin/v1/nodes"
    
    matchers-condition: and
    matchers:
      - type: status
        status: [200]
      
      - type: word
        words:
          - "nodes"
          - "node_id"
          - "address"
        condition: or

  # Database listing
  - method: GET
    path:
      - "/_admin/v1/databases"
      - "/_admin/v1/databases?include_schemas=true"
    
    matchers-condition: and
    matchers:
      - type: status
        status: [200]
      
      - type: word
        words:
          - "databases"
          - "database_name"
        condition: or

  # Cluster settings
  - method: GET
    path:
      - "/_admin/v1/settings"
      - "/_status/vars"
    
    matchers:
      - type: word
        words:
          - "cluster.organization"
          - "version.version"
          - "server.host_based_authentication"

  # Events and logs
  - method: GET
    path:
      - "/_admin/v1/events"
      - "/_status/logs"
    
    matchers:
      - type: status
        status: [200]

extractors:
  - type: regex
    name: cockroachdb_version
    regex:
      - '"build_tag":"(v[\\d\\.]+)"'
      - 'CockroachDB\\s+v([\\d\\.]+)'
  
  - type: regex
    name: cluster_id
    regex:
      - '"cluster_id":"([^"]+)"'
  
  - type: regex
    name: node_count
    regex:
      - '"node_id":(\\d+)'
    group: 1
  
  - type: json
    name: database_names
    json:
      - '.databases[].database_name'

# Network-level testing for SQL port
network:
  - protocol: tcp
    port: 26257
    
    payloads:
      # PostgreSQL wire protocol greeting
      - "\x00\x00\x00\x08\x04\xd2\x16\x2f"
    
    matchers:
      - type: word
        words:
          - "crdb_internal"
          - "postgres"

severity-details:
  critical:
    description: "Full database access without authentication"
    cvss_score: 10.0
    impact:
      - "Complete data exfiltration"
      - "Data modification/deletion"
      - "Cluster configuration tampering"
      - "Service disruption"

remediation: |
  1. Enable authentication immediately:
     - Stop insecure mode: Remove --insecure flag
     - Start with security: cockroach start --certs-dir=certs

  2. Create certificates for secure cluster:
     cockroach cert create-ca --certs-dir=certs --ca-key=ca.key
     cockroach cert create-node localhost 127.0.0.1 --certs-dir=certs --ca-key=ca.key
     cockroach cert create-client root --certs-dir=certs --ca-key=ca.key

  3. Create admin user with password:
     CREATE USER admin WITH PASSWORD 'strong_password';
     GRANT admin TO admin;

  4. Configure SQL authentication:
     CREATE USER app_user WITH PASSWORD 'strong_password';
     GRANT ALL ON DATABASE mydb TO app_user;

  5. Restrict Admin UI access:
     --http-addr=127.0.0.1:8080

  6. Enable TLS for Admin UI:
     --http-addr=localhost:8080
     --http-tls-cert=ui.crt
     --http-tls-key=ui.key

  7. Use firewall rules:
     iptables -A INPUT -p tcp --dport 26257 -s <trusted_network> -j ACCEPT
     iptables -A INPUT -p tcp --dport 26257 -j DROP

  8. Enable audit logging:
     SET CLUSTER SETTING server.auth_log.sql_connections.enabled = true;
     SET CLUSTER SETTING server.auth_log.sql_sessions.enabled = true;

  9. Network segmentation:
     - Deploy in private subnet
     - Use VPN for administrative access
     - Limit SQL port exposure

  10. Regular security audits:
      - Review user permissions
      - Monitor authentication logs
      - Update CockroachDB regularly
