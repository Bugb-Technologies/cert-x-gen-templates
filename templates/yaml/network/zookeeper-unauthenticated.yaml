id: zookeeper-unauthenticated-access
name: "Apache Zookeeper Unauthenticated Access"
author:
  name: "CERT-X-GEN Security Team"
  email: "security@cert-x-gen.io"
severity: critical
description: |
  Detects Apache Zookeeper instances exposed without authentication.
  Unauthenticated Zookeeper access allows:
  - Configuration tampering
  - Service disruption
  - Data manipulation in distributed systems

tags:
  - zookeeper
  - apache
  - unauthenticated
  - distributed-systems
  - coordination
  - network

language: yaml
confidence: 95

cwe:
  - CWE-306

references:
  - https://cwe.mitre.org/data/definitions/306.html
  - https://zookeeper.apache.org/doc/current/zookeeperProgrammers.html#sc_ZooKeeperAccessControl
  - https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zookeeper+and+SASL

network:
  - protocol: tcp
    port: 2181
    
    payloads:
      # Zookeeper "stat" four-letter word command
      - "stat"
      # Environment command
      - "envi"
      # Configuration command
      - "conf"
      # Server stats
      - "srvr"
      # Connections
      - "cons"
      # Watch info
      - "wchs"
      # Dump session info
      - "dump"
    
    matchers-condition: or
    matchers:
      - type: word
        words:
          - "Zookeeper version"
          - "Clients:"
          - "Latency min/avg/max"
          - "Received:"
          - "Sent:"
          - "Mode: "
        condition: or
        part: body
      
      - type: regex
        regex:
          - "Zookeeper version: \\d+\\.\\d+\\.\\d+"
          - "Mode: (standalone|leader|follower)"
          - "Node count: \\d+"
      
      # Matchers for "dump" command output
      - type: word
        words:
          - "SessionTracker dump"
          - "Session Sets"
          - "ephemeral nodes dump"
          - "Sessions with Ephemerals"
        condition: or
        part: body
      
      - type: regex
        regex:
          - "SessionTracker dump:"
          - "Session Sets \\(\\d+\\):"
          - "ephemeral nodes dump:"
          - "Sessions with Ephemerals \\(\\d+\\):"
        condition: or
        part: body

http:
  - method: GET
    path:
      - "/commands"
      - "/commands/stat"
      - "/commands/conf"
    
    matchers:
      - type: word
        words:
          - "zookeeper"
          - "version"
          - "clientPort"
        condition: or

extractors:
  - type: regex
    name: zookeeper_version
    regex:
      - "Zookeeper version: ([\\d\\.]+)"
  
  - type: regex
    name: mode
    regex:
      - "Mode: (standalone|leader|follower)"
  
  - type: regex
    name: node_count
    regex:
      - "Node count: (\\d+)"

remediation: |
  1. Enable SASL authentication in zoo.cfg:
     authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider
     requireClientAuthScheme=sasl

  2. Configure Kerberos for SASL:
     jaasLoginRenew=3600000
     
  3. Use ACLs for path-level permissions:
     setAcl /path auth:user:password:cdrwa

  4. Bind to localhost if used locally:
     clientPort=2181
     clientPortAddress=127.0.0.1

  5. Use firewall rules:
     iptables -A INPUT -p tcp --dport 2181 -s <trusted_network> -j ACCEPT
     iptables -A INPUT -p tcp --dport 2181 -j DROP

  6. Disable four-letter word commands (optional):
     4lw.commands.whitelist=stat,ruok,conf,isro

  7. Enable TLS/SSL:
     secureClientPort=2281
     ssl.keyStore.location=/path/to/keystore
     ssl.trustStore.location=/path/to/truststore

  8. Monitor for unauthorized access
  9. Regular security audits
  10. Keep Zookeeper updated
