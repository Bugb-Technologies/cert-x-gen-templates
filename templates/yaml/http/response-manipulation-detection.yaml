id: response-manipulation
name: "Response Manipulation & Cache Poisoning"
author:
  name: "CERT-X-GEN Security Team"
  email: "security@cert-x-gen.io"
severity: medium
description: |
  Detects response manipulation, cache poisoning, and HTTP parameter pollution.
  Analyzes response size differences and content variations.

tags:
  - cache-poisoning
  - hpp
  - response-manipulation
  - web-cache

language: yaml
confidence: 75

# HTTP request specifications
http:
  # Baseline request
  - method: GET
    path:
      - "/"
    
    headers:
      User-Agent: "cert-x-gen/1.0"
      X-Baseline: "true"
    
    matchers:
      - type: status
        status: [200]

  # Test cache poisoning with host header
  - method: GET
    path:
      - "/"
    
    headers:
      User-Agent: "cert-x-gen/1.0"
      Host: "evil.com"
      X-Forwarded-Host: "evil.com"
    
    matchers-condition: or
    matchers:
      - type: word
        words:
          - "evil.com"
        part: body
      
      - type: word
        words:
          - "evil.com"
        part: header

  # Test parameter pollution
  - method: GET
    path:
      - "/?page=home&page=admin"
      - "/?id=1&id=2"
      - "/?redirect=http://example.com&redirect=http://evil.com"
    
    matchers:
      - type: word
        words:
          - "admin"
          - "evil.com"
        condition: or

  # Test response size differences (potential DoS)
  - method: POST
    path:
      - "/search"
      - "/api/query"
    
    body: "query=AAAAA" # Repeat 'A' many times
    
    headers:
      Content-Type: "application/x-www-form-urlencoded"
    
    matchers-condition: or
    matchers:
      # Large response (amplification)
      - type: size
        condition: greater
        size: 100000
      
      # Response time issues
      - type: time
        condition: greater
        time: 3s

  # Test header injection
  - method: GET
    path:
      - "/?redirect=/%0d%0aSet-Cookie:admin=true"
      - "/?url=/%0d%0aLocation:evil.com"
    
    matchers:
      - type: word
        words:
          - "Set-Cookie"
          - "Location: evil"
        condition: or
        part: header
